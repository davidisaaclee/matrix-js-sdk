{"version":3,"file":"matrix.js","names":["requestInstance","request","r","getRequest","wrapRequest","wrapper","origRequest","options","callback","cryptoStoreFactory","MemoryCryptoStore","setCryptoStoreFactory","fac","createClient","opts","store","MemoryStore","localStorage","global","scheduler","MatrixScheduler","cryptoStore","MatrixClient"],"sources":["../src/matrix.ts"],"sourcesContent":["/*\nCopyright 2015-2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MemoryCryptoStore } from \"./crypto/store/memory-crypto-store\";\nimport { MemoryStore } from \"./store/memory\";\nimport { MatrixScheduler } from \"./scheduler\";\nimport { MatrixClient, ICreateClientOpts } from \"./client\";\nimport { DeviceTrustLevel } from \"./crypto/CrossSigning\";\nimport { ISecretStorageKeyInfo } from \"./crypto/api\";\n\nexport * from \"./client\";\nexport * from \"./http-api\";\nexport * from \"./autodiscovery\";\nexport * from \"./sync-accumulator\";\nexport * from \"./errors\";\nexport * from \"./models/beacon\";\nexport * from \"./models/event\";\nexport * from \"./models/room\";\nexport * from \"./models/event-timeline\";\nexport * from \"./models/event-timeline-set\";\nexport * from \"./models/room-member\";\nexport * from \"./models/room-state\";\nexport * from \"./models/user\";\nexport * from \"./scheduler\";\nexport * from \"./filter\";\nexport * from \"./timeline-window\";\nexport * from \"./interactive-auth\";\nexport * from \"./service-types\";\nexport * from \"./store/memory\";\nexport * from \"./store/indexeddb\";\nexport * from \"./crypto/store/memory-crypto-store\";\nexport * from \"./crypto/store/indexeddb-crypto-store\";\nexport * from \"./content-repo\";\nexport * from './@types/event';\nexport * from './@types/PushRules';\nexport * from './@types/partials';\nexport * from './@types/requests';\nexport * from './@types/search';\nexport * from './models/room-summary';\nexport * as ContentHelpers from \"./content-helpers\";\nexport {\n    createNewMatrixCall,\n} from \"./webrtc/call\";\nexport { SyncState } from './sync';\n\n// expose the underlying request object so different environments can use\n// different request libs (e.g. request or browser-request)\nlet requestInstance;\n\n/**\n * The function used to perform HTTP requests. Only use this if you want to\n * use a different HTTP library, e.g. Angular's <code>$http</code>. This should\n * be set prior to calling {@link createClient}.\n * @param {requestFunction} r The request function to use.\n */\nexport function request(r) {\n    requestInstance = r;\n}\n\n/**\n * Return the currently-set request function.\n * @return {requestFunction} The current request function.\n */\nexport function getRequest() {\n    return requestInstance;\n}\n\n/**\n * Apply wrapping code around the request function. The wrapper function is\n * installed as the new request handler, and when invoked it is passed the\n * previous value, along with the options and callback arguments.\n * @param {requestWrapperFunction} wrapper The wrapping function.\n */\nexport function wrapRequest(wrapper) {\n    const origRequest = requestInstance;\n    requestInstance = function(options, callback) {\n        return wrapper(origRequest, options, callback);\n    };\n}\n\nlet cryptoStoreFactory = () => new MemoryCryptoStore;\n\n/**\n * Configure a different factory to be used for creating crypto stores\n *\n * @param {Function} fac  a function which will return a new\n *    {@link module:crypto.store.base~CryptoStore}.\n */\nexport function setCryptoStoreFactory(fac) {\n    cryptoStoreFactory = fac;\n}\n\nexport interface ICryptoCallbacks {\n    getCrossSigningKey?: (keyType: string, pubKey: string) => Promise<Uint8Array>;\n    saveCrossSigningKeys?: (keys: Record<string, Uint8Array>) => void;\n    shouldUpgradeDeviceVerifications?: (\n        users: Record<string, any>\n    ) => Promise<string[]>;\n    getSecretStorageKey?: (\n        keys: {keys: Record<string, ISecretStorageKeyInfo>}, name: string\n    ) => Promise<[string, Uint8Array] | null>;\n    cacheSecretStorageKey?: (\n        keyId: string, keyInfo: ISecretStorageKeyInfo, key: Uint8Array\n    ) => void;\n    onSecretRequested?: (\n        userId: string, deviceId: string,\n        requestId: string, secretName: string, deviceTrust: DeviceTrustLevel\n    ) => Promise<string>;\n    getDehydrationKey?: (\n        keyInfo: ISecretStorageKeyInfo,\n        checkFunc: (key: Uint8Array) => void,\n    ) => Promise<Uint8Array>;\n    getBackupKey?: () => Promise<Uint8Array>;\n}\n\n/**\n * Construct a Matrix Client. Similar to {@link module:client.MatrixClient}\n * except that the 'request', 'store' and 'scheduler' dependencies are satisfied.\n * @param {(Object|string)} opts The configuration options for this client. If\n * this is a string, it is assumed to be the base URL. These configuration\n * options will be passed directly to {@link module:client.MatrixClient}.\n * @param {Object} opts.store If not set, defaults to\n * {@link module:store/memory.MemoryStore}.\n * @param {Object} opts.scheduler If not set, defaults to\n * {@link module:scheduler~MatrixScheduler}.\n * @param {requestFunction} opts.request If not set, defaults to the function\n * supplied to {@link request} which defaults to the request module from NPM.\n *\n * @param {module:crypto.store.base~CryptoStore=} opts.cryptoStore\n *    crypto store implementation. Calls the factory supplied to\n *    {@link setCryptoStoreFactory} if unspecified; or if no factory has been\n *    specified, uses a default implementation (indexeddb in the browser,\n *    in-memory otherwise).\n *\n * @return {MatrixClient} A new matrix client.\n * @see {@link module:client.MatrixClient} for the full list of options for\n * <code>opts</code>.\n */\nexport function createClient(opts: ICreateClientOpts | string) {\n    if (typeof opts === \"string\") {\n        opts = {\n            \"baseUrl\": opts,\n        };\n    }\n    opts.request = opts.request || requestInstance;\n    opts.store = opts.store || new MemoryStore({\n        localStorage: global.localStorage,\n    });\n    opts.scheduler = opts.scheduler || new MatrixScheduler();\n    opts.cryptoStore = opts.cryptoStore || cryptoStoreFactory();\n    return new MatrixClient(opts);\n}\n\n/**\n * The request function interface for performing HTTP requests. This matches the\n * API for the {@link https://github.com/request/request#requestoptions-callback|\n * request NPM module}. The SDK will attempt to call this function in order to\n * perform an HTTP request.\n * @callback requestFunction\n * @param {Object} opts The options for this HTTP request.\n * @param {string} opts.uri The complete URI.\n * @param {string} opts.method The HTTP method.\n * @param {Object} opts.qs The query parameters to append to the URI.\n * @param {Object} opts.body The JSON-serializable object.\n * @param {boolean} opts.json True if this is a JSON request.\n * @param {Object} opts._matrix_opts The underlying options set for\n * {@link MatrixHttpApi}.\n * @param {requestCallback} callback The request callback.\n */\n\n/**\n * A wrapper for the request function interface.\n * @callback requestWrapperFunction\n * @param {requestFunction} origRequest The underlying request function being\n * wrapped\n * @param {Object} opts The options for this HTTP request, given in the same\n * form as {@link requestFunction}.\n * @param {requestCallback} callback The request callback.\n */\n\n/**\n  * The request callback interface for performing HTTP requests. This matches the\n  * API for the {@link https://github.com/request/request#requestoptions-callback|\n  * request NPM module}. The SDK will implement a callback which meets this\n  * interface in order to handle the HTTP response.\n  * @callback requestCallback\n  * @param {Error} err The error if one occurred, else falsey.\n  * @param {Object} response The HTTP response which consists of\n  * <code>{statusCode: {Number}, headers: {Object}}</code>\n  * @param {Object} body The parsed HTTP response body.\n  */\n"],"mappings":"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kB,GAAGG,GAAG;AAC5B;AAyBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASC,YAAY,CAACC,IAAgC,EAAE;EAC3D,IAAI,OAAOA,IAAI,KAAK,QAAQ,EAAE;IAC1BA,IAAI,GAAG;MACH,SAAS,EAAEA;IACf,CAAC;EACL;EACAA,IAAI,CAACb,OAAO,GAAGa,IAAI,CAACb,OAAO,IAAID,eAAe;EAC9Cc,IAAI,CAACC,KAAK,GAAGD,IAAI,CAACC,KAAK,IAAI,IAAIC,mBAAW,CAAC;IACvCC,YAAY,EAAEC,MAAM,CAACD;EACzB,CAAC,CAAC;EACFH,IAAI,CAACK,SAAS,GAAGL,IAAI,CAACK,SAAS,IAAI,IAAIC,0BAAe,EAAE;EACxDN,IAAI,CAACO,WAAW,GAAGP,IAAI,CAACO,WAAW,IAAIZ,kBAAkB,EAAE;EAC3D,OAAO,IAAIa,oBAAY,CAACR,IAAI,CAAC;AACjC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"}