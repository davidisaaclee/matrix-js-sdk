{"version":3,"file":"beacon.js","names":["BeaconEvent","isTimestampInDuration","startTimestamp","durationMs","timestamp","getBeaconInfoIdentifier","event","getRoomId","getStateKey","Beacon","TypedEventEmitter","constructor","rootEvent","_latestLocationEvent","undefined","emit","LocationUpdate","latestLocationState","setBeaconInfo","roomId","isLive","_isLive","identifier","beaconInfoId","getId","beaconInfoOwner","beaconInfoEventType","getType","beaconInfo","_beaconInfo","parseBeaconContent","getContent","latestLocationEvent","update","beaconInfoEvent","Error","getTs","Update","clearLatestLocation","destroy","livenessWatchTimeout","clearTimeout","Destroy","monitorLiveness","checkLiveness","expiryInMs","timeout","Date","now","setTimeout","addLocations","beaconLocationEvents","validLocationEvents","filter","content","parsed","uri","sort","sortEventsByLatestContentTimestamp","parseBeaconInfoContent","prevLiveness","live","LivenessChange"],"sources":["../../src/models/beacon.ts"],"sourcesContent":["/*\nCopyright 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MBeaconEventContent } from \"../@types/beacon\";\nimport { BeaconInfoState, BeaconLocationState, parseBeaconContent, parseBeaconInfoContent } from \"../content-helpers\";\nimport { MatrixEvent } from \"./event\";\nimport { sortEventsByLatestContentTimestamp } from \"../utils\";\nimport { TypedEventEmitter } from \"./typed-event-emitter\";\n\nexport enum BeaconEvent {\n    New = \"Beacon.new\",\n    Update = \"Beacon.update\",\n    LivenessChange = \"Beacon.LivenessChange\",\n    Destroy = \"Beacon.Destroy\",\n    LocationUpdate = \"Beacon.LocationUpdate\",\n}\n\nexport type BeaconEventHandlerMap = {\n    [BeaconEvent.Update]: (event: MatrixEvent, beacon: Beacon) => void;\n    [BeaconEvent.LivenessChange]: (isLive: boolean, beacon: Beacon) => void;\n    [BeaconEvent.Destroy]: (beaconIdentifier: string) => void;\n    [BeaconEvent.LocationUpdate]: (locationState: BeaconLocationState) => void;\n    [BeaconEvent.Destroy]: (beaconIdentifier: string) => void;\n};\n\nexport const isTimestampInDuration = (startTimestamp: number, durationMs: number, timestamp: number): boolean =>\n    timestamp >= startTimestamp && startTimestamp + durationMs >= timestamp;\n\n// beacon info events are uniquely identified by\n// `<roomId>_<state_key>`\nexport type BeaconIdentifier = string;\nexport const getBeaconInfoIdentifier = (event: MatrixEvent): BeaconIdentifier =>\n    `${event.getRoomId()}_${event.getStateKey()}`;\n\n// https://github.com/matrix-org/matrix-spec-proposals/pull/3672\nexport class Beacon extends TypedEventEmitter<Exclude<BeaconEvent, BeaconEvent.New>, BeaconEventHandlerMap> {\n    public readonly roomId: string;\n    private _beaconInfo?: BeaconInfoState;\n    private _isLive?: boolean;\n    private livenessWatchTimeout?: ReturnType<typeof setTimeout>;\n    private _latestLocationEvent?: MatrixEvent;\n\n    public constructor(private rootEvent: MatrixEvent) {\n        super();\n        this.setBeaconInfo(this.rootEvent);\n        this.roomId = this.rootEvent.getRoomId()!;\n    }\n\n    public get isLive(): boolean {\n        return !!this._isLive;\n    }\n\n    public get identifier(): BeaconIdentifier {\n        return getBeaconInfoIdentifier(this.rootEvent);\n    }\n\n    public get beaconInfoId(): string {\n        return this.rootEvent.getId()!;\n    }\n\n    public get beaconInfoOwner(): string {\n        return this.rootEvent.getStateKey()!;\n    }\n\n    public get beaconInfoEventType(): string {\n        return this.rootEvent.getType();\n    }\n\n    public get beaconInfo(): BeaconInfoState | undefined {\n        return this._beaconInfo;\n    }\n\n    public get latestLocationState(): BeaconLocationState | undefined {\n        return this._latestLocationEvent && parseBeaconContent(this._latestLocationEvent.getContent());\n    }\n\n    public get latestLocationEvent(): MatrixEvent | undefined {\n        return this._latestLocationEvent;\n    }\n\n    public update(beaconInfoEvent: MatrixEvent): void {\n        if (getBeaconInfoIdentifier(beaconInfoEvent) !== this.identifier) {\n            throw new Error(\"Invalid updating event\");\n        }\n        // don't update beacon with an older event\n        if (beaconInfoEvent.getTs() < this.rootEvent.getTs()) {\n            return;\n        }\n        this.rootEvent = beaconInfoEvent;\n        this.setBeaconInfo(this.rootEvent);\n\n        this.emit(BeaconEvent.Update, beaconInfoEvent, this);\n        this.clearLatestLocation();\n    }\n\n    public destroy(): void {\n        if (this.livenessWatchTimeout) {\n            clearTimeout(this.livenessWatchTimeout);\n        }\n\n        this._isLive = false;\n        this.emit(BeaconEvent.Destroy, this.identifier);\n    }\n\n    /**\n     * Monitor liveness of a beacon\n     * Emits BeaconEvent.LivenessChange when beacon expires\n     */\n    public monitorLiveness(): void {\n        if (this.livenessWatchTimeout) {\n            clearTimeout(this.livenessWatchTimeout);\n        }\n\n        this.checkLiveness();\n        if (!this.beaconInfo) return;\n        if (this.isLive) {\n            const expiryInMs = this.beaconInfo.timestamp! + this.beaconInfo.timeout - Date.now();\n            if (expiryInMs > 1) {\n                this.livenessWatchTimeout = setTimeout(() => {\n                    this.monitorLiveness();\n                }, expiryInMs);\n            }\n        } else if (this.beaconInfo.timestamp! > Date.now()) {\n            // beacon start timestamp is in the future\n            // check liveness again then\n            this.livenessWatchTimeout = setTimeout(() => {\n                this.monitorLiveness();\n            }, this.beaconInfo.timestamp! - Date.now());\n        }\n    }\n\n    /**\n     * Process Beacon locations\n     * Emits BeaconEvent.LocationUpdate\n     */\n    public addLocations(beaconLocationEvents: MatrixEvent[]): void {\n        // discard locations for beacons that are not live\n        if (!this.isLive) {\n            return;\n        }\n\n        const validLocationEvents = beaconLocationEvents.filter((event) => {\n            const content = event.getContent<MBeaconEventContent>();\n            const parsed = parseBeaconContent(content);\n            if (!parsed.uri || !parsed.timestamp) return false; // we won't be able to process these\n            const { timestamp } = parsed;\n            return (\n                this._beaconInfo!.timestamp &&\n                // only include positions that were taken inside the beacon's live period\n                isTimestampInDuration(this._beaconInfo!.timestamp, this._beaconInfo!.timeout, timestamp) &&\n                // ignore positions older than our current latest location\n                (!this.latestLocationState || timestamp > this.latestLocationState.timestamp!)\n            );\n        });\n        const latestLocationEvent = validLocationEvents.sort(sortEventsByLatestContentTimestamp)?.[0];\n\n        if (latestLocationEvent) {\n            this._latestLocationEvent = latestLocationEvent;\n            this.emit(BeaconEvent.LocationUpdate, this.latestLocationState!);\n        }\n    }\n\n    private clearLatestLocation = (): void => {\n        this._latestLocationEvent = undefined;\n        this.emit(BeaconEvent.LocationUpdate, this.latestLocationState!);\n    };\n\n    private setBeaconInfo(event: MatrixEvent): void {\n        this._beaconInfo = parseBeaconInfoContent(event.getContent());\n        this.checkLiveness();\n    }\n\n    private checkLiveness(): void {\n        const prevLiveness = this.isLive;\n\n        // element web sets a beacon's start timestamp to the senders local current time\n        // when Alice's system clock deviates slightly from Bob's a beacon Alice intended to be live\n        // may have a start timestamp in the future from Bob's POV\n        // handle this by adding 6min of leniency to the start timestamp when it is in the future\n        if (!this.beaconInfo) return;\n        const startTimestamp =\n            this.beaconInfo.timestamp! > Date.now()\n                ? this.beaconInfo.timestamp! - 360000 /* 6min */\n                : this.beaconInfo.timestamp;\n        this._isLive =\n            !!this._beaconInfo?.live &&\n            !!startTimestamp &&\n            isTimestampInDuration(startTimestamp, this._beaconInfo?.timeout, Date.now());\n\n        if (prevLiveness !== this.isLive) {\n            this.emit(BeaconEvent.LivenessChange, this.isLive, this);\n        }\n    }\n}\n"],"mappings":"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"}