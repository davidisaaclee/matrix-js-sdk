{"version":3,"file":"relations-container.js","names":["RelationsContainer","constructor","client","room","Map","getChildEventsForEvent","eventId","relationType","eventType","relations","get","getAllChildEventsForEvent","parentEventId","relationsForEvent","events","relationsRecord","values","push","getRelations","aggregateParentEvent","event","getId","relationsWithRelType","relationsWithEventType","setTargetEvent","aggregateChildEvent","timelineSet","isRedacted","status","EventStatus","CANCELLED","relation","getRelation","onEventDecrypted","isDecryptionFailure","once","MatrixEventEvent","Decrypted","isBeingDecrypted","shouldAttemptDecryption","event_id","relatesToEventId","rel_type","getType","set","Relations","relatesToEvent","findEventById","getPendingEvent","addEvent"],"sources":["../../src/models/relations-container.ts"],"sourcesContent":["/*\nCopyright 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { Relations } from \"./relations\";\nimport { EventType, RelationType } from \"../@types/event\";\nimport { EventStatus, MatrixEvent, MatrixEventEvent } from \"./event\";\nimport { EventTimelineSet } from \"./event-timeline-set\";\nimport { MatrixClient } from \"../client\";\nimport { Room } from \"./room\";\n\nexport class RelationsContainer {\n    // A tree of objects to access a set of related children for an event, as in:\n    // this.relations.get(parentEventId).get(relationType).get(relationEventType)\n    private relations = new Map<string, Map<RelationType | string, Map<EventType | string, Relations>>>();\n\n    constructor(private readonly client: MatrixClient, private readonly room?: Room) {\n    }\n\n    /**\n     * Get a collection of child events to a given event in this timeline set.\n     *\n     * @param {String} eventId\n     * The ID of the event that you'd like to access child events for.\n     * For example, with annotations, this would be the ID of the event being annotated.\n     * @param {String} relationType\n     * The type of relationship involved, such as \"m.annotation\", \"m.reference\", \"m.replace\", etc.\n     * @param {String} eventType\n     * The relation event's type, such as \"m.reaction\", etc.\n     * @throws If <code>eventId</code>, <code>relationType</code> or <code>eventType</code>\n     * are not valid.\n     *\n     * @returns {?Relations}\n     * A container for relation events or undefined if there are no relation events for\n     * the relationType.\n     */\n    public getChildEventsForEvent(\n        eventId: string,\n        relationType: RelationType | string,\n        eventType: EventType | string,\n    ): Relations | undefined {\n        return this.relations.get(eventId)?.get(relationType)?.get(eventType);\n    }\n\n    public getAllChildEventsForEvent(parentEventId: string): MatrixEvent[] {\n        const relationsForEvent = this.relations.get(parentEventId)\n            ?? new Map<RelationType | string, Map<EventType | string, Relations>>();\n        const events: MatrixEvent[] = [];\n        for (const relationsRecord of relationsForEvent.values()) {\n            for (const relations of relationsRecord.values()) {\n                events.push(...relations.getRelations());\n            }\n        }\n        return events;\n    }\n\n    /**\n     * Set an event as the target event if any Relations exist for it already.\n     * Child events can point to other child events as their parent, so this method may be\n     * called for events which are also logically child events.\n     *\n     * @param {MatrixEvent} event The event to check as relation target.\n     */\n    public aggregateParentEvent(event: MatrixEvent): void {\n        const relationsForEvent = this.relations.get(event.getId());\n        if (!relationsForEvent) return;\n\n        for (const relationsWithRelType of relationsForEvent.values()) {\n            for (const relationsWithEventType of relationsWithRelType.values()) {\n                relationsWithEventType.setTargetEvent(event);\n            }\n        }\n    }\n\n    /**\n     * Add relation events to the relevant relation collection.\n     *\n     * @param {MatrixEvent} event The new child event to be aggregated.\n     * @param {EventTimelineSet} timelineSet The event timeline set within which to search for the related event if any.\n     */\n    public aggregateChildEvent(event: MatrixEvent, timelineSet?: EventTimelineSet): void {\n        if (event.isRedacted() || event.status === EventStatus.CANCELLED) {\n            return;\n        }\n\n        const relation = event.getRelation();\n        if (!relation) return;\n\n        const onEventDecrypted = () => {\n            if (event.isDecryptionFailure()) {\n                // This could for example happen if the encryption keys are not yet available.\n                // The event may still be decrypted later. Register the listener again.\n                event.once(MatrixEventEvent.Decrypted, onEventDecrypted);\n                return;\n            }\n\n            this.aggregateChildEvent(event, timelineSet);\n        };\n\n        // If the event is currently encrypted, wait until it has been decrypted.\n        if (event.isBeingDecrypted() || event.shouldAttemptDecryption()) {\n            event.once(MatrixEventEvent.Decrypted, onEventDecrypted);\n            return;\n        }\n\n        const { event_id: relatesToEventId, rel_type: relationType } = relation;\n        const eventType = event.getType();\n\n        let relationsForEvent = this.relations.get(relatesToEventId);\n        if (!relationsForEvent) {\n            relationsForEvent = new Map<RelationType | string, Map<EventType | string, Relations>>();\n            this.relations.set(relatesToEventId, relationsForEvent);\n        }\n\n        let relationsWithRelType = relationsForEvent.get(relationType);\n        if (!relationsWithRelType) {\n            relationsWithRelType = new Map<EventType | string, Relations>();\n            relationsForEvent.set(relationType, relationsWithRelType);\n        }\n\n        let relationsWithEventType = relationsWithRelType.get(eventType);\n        if (!relationsWithEventType) {\n            relationsWithEventType = new Relations(\n                relationType,\n                eventType,\n                this.client,\n            );\n            relationsWithRelType.set(eventType, relationsWithEventType);\n\n            const room = this.room ?? timelineSet?.room;\n            const relatesToEvent = timelineSet?.findEventById(relatesToEventId)\n                ?? room?.findEventById(relatesToEventId)\n                ?? room?.getPendingEvent(relatesToEventId);\n            if (relatesToEvent) {\n                relationsWithEventType.setTargetEvent(relatesToEvent);\n            }\n        }\n\n        relationsWithEventType.addEvent(event);\n    }\n}\n"],"mappings":"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"}