{"version":3,"file":"aes.js","names":["subtleCrypto","window","crypto","subtle","webkitSubtle","zeroSalt","Uint8Array","encryptNode","data","key","name","ivStr","getCrypto","Error","iv","decodeBase64","randomBytes","aesKey","hmacKey","deriveKeysNode","cipher","createCipheriv","ciphertext","Buffer","concat","update","final","hmac","createHmac","digest","encodeBase64","toString","mac","decryptNode","from","replace","decipher","createDecipheriv","prk","b","alloc","encryptBrowser","getRandomValues","deriveKeysBrowser","encodedData","TextEncoder","encode","encrypt","counter","length","sign","decryptBrowser","verify","plaintext","decrypt","TextDecoder","decode","hkdfkey","importKey","keybits","deriveBits","salt","info","hash","slice","aesProm","hmacProm","Promise","all","encryptAES","decryptAES","ZERO_STR","calculateKeyCheck"],"sources":["../../src/crypto/aes.ts"],"sourcesContent":["/*\nCopyright 2020 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport type { BinaryLike } from \"crypto\";\nimport { getCrypto } from '../utils';\nimport { decodeBase64, encodeBase64 } from './olmlib';\n\nconst subtleCrypto = (typeof window !== \"undefined\" && window.crypto) ?\n    (window.crypto.subtle || window.crypto.webkitSubtle) : null;\n\n// salt for HKDF, with 8 bytes of zeros\nconst zeroSalt = new Uint8Array(8);\n\nexport interface IEncryptedPayload {\n    [key: string]: any; // extensible\n    iv?: string;\n    ciphertext?: string;\n    mac?: string;\n}\n\n/**\n * encrypt a string in Node.js\n *\n * @param {string} data the plaintext to encrypt\n * @param {Uint8Array} key the encryption key to use\n * @param {string} name the name of the secret\n * @param {string} ivStr the initialization vector to use\n */\nasync function encryptNode(data: string, key: Uint8Array, name: string, ivStr?: string): Promise<IEncryptedPayload> {\n    const crypto = getCrypto();\n    if (!crypto) {\n        throw new Error(\"No usable crypto implementation\");\n    }\n\n    let iv;\n    if (ivStr) {\n        iv = decodeBase64(ivStr);\n    } else {\n        iv = crypto.randomBytes(16);\n\n        // clear bit 63 of the IV to stop us hitting the 64-bit counter boundary\n        // (which would mean we wouldn't be able to decrypt on Android). The loss\n        // of a single bit of iv is a price we have to pay.\n        iv[8] &= 0x7f;\n    }\n\n    const [aesKey, hmacKey] = deriveKeysNode(key, name);\n\n    const cipher = crypto.createCipheriv(\"aes-256-ctr\", aesKey, iv);\n    const ciphertext = Buffer.concat([\n        cipher.update(data, \"utf8\"),\n        cipher.final(),\n    ]);\n\n    const hmac = crypto.createHmac(\"sha256\", hmacKey)\n        .update(ciphertext).digest(\"base64\");\n\n    return {\n        iv: encodeBase64(iv),\n        ciphertext: ciphertext.toString(\"base64\"),\n        mac: hmac,\n    };\n}\n\n/**\n * decrypt a string in Node.js\n *\n * @param {object} data the encrypted data\n * @param {string} data.ciphertext the ciphertext in base64\n * @param {string} data.iv the initialization vector in base64\n * @param {string} data.mac the HMAC in base64\n * @param {Uint8Array} key the encryption key to use\n * @param {string} name the name of the secret\n */\nasync function decryptNode(data: IEncryptedPayload, key: Uint8Array, name: string): Promise<string> {\n    const crypto = getCrypto();\n    if (!crypto) {\n        throw new Error(\"No usable crypto implementation\");\n    }\n\n    const [aesKey, hmacKey] = deriveKeysNode(key, name);\n\n    const hmac = crypto.createHmac(\"sha256\", hmacKey)\n        .update(Buffer.from(data.ciphertext, \"base64\"))\n        .digest(\"base64\").replace(/=+$/g, '');\n\n    if (hmac !== data.mac.replace(/=+$/g, '')) {\n        throw new Error(`Error decrypting secret ${name}: bad MAC`);\n    }\n\n    const decipher = crypto.createDecipheriv(\n        \"aes-256-ctr\", aesKey, decodeBase64(data.iv),\n    );\n    return decipher.update(data.ciphertext, \"base64\", \"utf8\")\n          + decipher.final(\"utf8\");\n}\n\nfunction deriveKeysNode(key: BinaryLike, name: string): [Buffer, Buffer] {\n    const crypto = getCrypto();\n    const prk = crypto.createHmac(\"sha256\", zeroSalt).update(key).digest();\n\n    const b = Buffer.alloc(1, 1);\n    const aesKey = crypto.createHmac(\"sha256\", prk)\n        .update(name, \"utf8\").update(b).digest();\n    b[0] = 2;\n    const hmacKey = crypto.createHmac(\"sha256\", prk)\n        .update(aesKey).update(name, \"utf8\").update(b).digest();\n\n    return [aesKey, hmacKey];\n}\n\n/**\n * encrypt a string in Node.js\n *\n * @param {string} data the plaintext to encrypt\n * @param {Uint8Array} key the encryption key to use\n * @param {string} name the name of the secret\n * @param {string} ivStr the initialization vector to use\n */\nasync function encryptBrowser(data: string, key: Uint8Array, name: string, ivStr?: string): Promise<IEncryptedPayload> {\n    let iv;\n    if (ivStr) {\n        iv = decodeBase64(ivStr);\n    } else {\n        iv = new Uint8Array(16);\n        window.crypto.getRandomValues(iv);\n\n        // clear bit 63 of the IV to stop us hitting the 64-bit counter boundary\n        // (which would mean we wouldn't be able to decrypt on Android). The loss\n        // of a single bit of iv is a price we have to pay.\n        iv[8] &= 0x7f;\n    }\n\n    const [aesKey, hmacKey] = await deriveKeysBrowser(key, name);\n    const encodedData = new TextEncoder().encode(data);\n\n    const ciphertext = await subtleCrypto.encrypt(\n        {\n            name: \"AES-CTR\",\n            counter: iv,\n            length: 64,\n        },\n        aesKey,\n        encodedData,\n    );\n\n    const hmac = await subtleCrypto.sign(\n        { name: 'HMAC' },\n        hmacKey,\n        ciphertext,\n    );\n\n    return {\n        iv: encodeBase64(iv),\n        ciphertext: encodeBase64(ciphertext),\n        mac: encodeBase64(hmac),\n    };\n}\n\n/**\n * decrypt a string in the browser\n *\n * @param {object} data the encrypted data\n * @param {string} data.ciphertext the ciphertext in base64\n * @param {string} data.iv the initialization vector in base64\n * @param {string} data.mac the HMAC in base64\n * @param {Uint8Array} key the encryption key to use\n * @param {string} name the name of the secret\n */\nasync function decryptBrowser(data: IEncryptedPayload, key: Uint8Array, name: string): Promise<string> {\n    const [aesKey, hmacKey] = await deriveKeysBrowser(key, name);\n\n    const ciphertext = decodeBase64(data.ciphertext);\n\n    if (!await subtleCrypto.verify(\n        { name: \"HMAC\" },\n        hmacKey,\n        decodeBase64(data.mac),\n        ciphertext,\n    )) {\n        throw new Error(`Error decrypting secret ${name}: bad MAC`);\n    }\n\n    const plaintext = await subtleCrypto.decrypt(\n        {\n            name: \"AES-CTR\",\n            counter: decodeBase64(data.iv),\n            length: 64,\n        },\n        aesKey,\n        ciphertext,\n    );\n\n    return new TextDecoder().decode(new Uint8Array(plaintext));\n}\n\nasync function deriveKeysBrowser(key: Uint8Array, name: string): Promise<[CryptoKey, CryptoKey]> {\n    const hkdfkey = await subtleCrypto.importKey(\n        'raw',\n        key,\n        { name: \"HKDF\" },\n        false,\n        [\"deriveBits\"],\n    );\n    const keybits = await subtleCrypto.deriveBits(\n        {\n            name: \"HKDF\",\n            salt: zeroSalt,\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore: https://github.com/microsoft/TypeScript-DOM-lib-generator/pull/879\n            info: (new TextEncoder().encode(name)),\n            hash: \"SHA-256\",\n        },\n        hkdfkey,\n        512,\n    );\n\n    const aesKey = keybits.slice(0, 32);\n    const hmacKey = keybits.slice(32);\n\n    const aesProm = subtleCrypto.importKey(\n        'raw',\n        aesKey,\n        { name: 'AES-CTR' },\n        false,\n        ['encrypt', 'decrypt'],\n    );\n\n    const hmacProm = subtleCrypto.importKey(\n        'raw',\n        hmacKey,\n        {\n            name: 'HMAC',\n            hash: { name: 'SHA-256' },\n        },\n        false,\n        ['sign', 'verify'],\n    );\n\n    return Promise.all([aesProm, hmacProm]);\n}\n\nexport function encryptAES(data: string, key: Uint8Array, name: string, ivStr?: string): Promise<IEncryptedPayload> {\n    return subtleCrypto ? encryptBrowser(data, key, name, ivStr) : encryptNode(data, key, name, ivStr);\n}\n\nexport function decryptAES(data: IEncryptedPayload, key: Uint8Array, name: string): Promise<string> {\n    return subtleCrypto ? decryptBrowser(data, key, name) : decryptNode(data, key, name);\n}\n\n// string of zeroes, for calculating the key check\nconst ZERO_STR = \"\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\";\n\n/** Calculate the MAC for checking the key.\n *\n * @param {Uint8Array} key the key to use\n * @param {string} [iv] The initialization vector as a base64-encoded string.\n *     If omitted, a random initialization vector will be created.\n * @return {Promise<object>} An object that contains, `mac` and `iv` properties.\n */\nexport function calculateKeyCheck(key: Uint8Array, iv?: string): Promise<IEncryptedPayload> {\n    return encryptAES(ZERO_STR, key, \"\", iv);\n}\n"],"mappings":"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"}